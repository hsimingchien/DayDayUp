相关模块提供给UA的接口
需要给用量累计UA模块提供接口的模块有DATA模块、UC模块、DB模块，以及动态管理模块。

UC模块提供给本模块的接口
查询用户的计费方式，获取月起始日期
输入：IMSI
输出：a) BYTE类型的计费方式（有两种：自然月，启帐日顺延）
b) 起始日期。

查询用户、套餐、SI是否有效
输入：a) IMSI，PAKID，SI
输出：无。
返回： 有效 或 无效。

获取套餐相关属性 ucGetPakAttrInfo
输入：a) IMSI，PAKID
输出：套餐清零时间点、套餐属性（用户套餐或业务套餐）、 当前套餐用量是否需要清零、套餐有效期是否有周期性属性、周期性有效期清零周期天数、 套餐周起始日。
返回：成功 或 失败。

BMGX模块提供给本模块的接口
根据NAI ID，判断此NAI是否有效。
输入：NAI ID
输出：无。
返回：有效 或 无效。

根据NAI ID，获取NAI的字串内容
输入：NAI ID，输出缓冲区最大长度。
输出：NAI字串内容。
返回：成功 或 失败。

DATA模块提供给本模块的接口
提供数据的存储管理，查询以及备份操作。

DB提供给本模块的接口
UA模块的相关配置都是从DB中获取，因此DB需要提供

获取UA模块配置接口，包括：获取周起始日、获取用量上报增量阈值、获取用量上报时间间隔。
配置修改的通知。
用量阈值事件注册表
以上内容已在网管配置及DB需求中详细说明。

动态管理
提供负责人机命令注册接口。提供用量查询接口（查询消息发送给UA模块，UA将查询到用量封装并发送）。

其他
FM要提供注册接口。
OSS子系统提供支撑。


用量获取：通过Sp’接口发送UDR消息向SPR获取用户的用量数据。
用量订阅：调用UA的订阅接口，订阅累计对象的累计用量达到阈值时的通知。
用量注销：调用UA的注销接口，通知UA删除“累计数据”或“事件通知”。
用量同步：通过Sp’接口发送UDR消息至SPR，向其同步当前用户的用量累计数据。

大增量上报：是指向SPR同步用量时，只同步用量累计值发生变化了的用量记录。
增量同步：对于每条用量记录，只上报用量增量值。

“用量上报”触发条件：
1：在解析获取到用量时，发现该用量无效（解析错误、套餐或SI非法等等），则会触发用量同步，将这些无效的用量从SPR中删除。
2：用量累计过程中，如果当前累计总值与上次同步的值之差超过阈值（网管配置）或者上次同步的时间距离现在超过间隔（网管配置），并且这期间用量发生了变化，则UA发送事件FM，通知同步用量。
3：用户下线时，如果上次上报和当前累计值不同，会触发用量同步。

如果向SPR用量同步失败收到UDA有错误码时，不会再次立即同步。等下次量同步时会将之前同步失败的用量一起同步给SPR；如果向SPR同步用量超时（等待UDA超时），则FS会再次触发同步（最多3次）。
用量累计：当PCEF向RCP上报用量时，FM调用UA的同步接口进行用量累计。

用量累计过程中，需要考虑以下问题：
1、用量是否需要清零；
根据累计类型，调用清零判断处理回调函数。
对于用户用量树、组用量树，检查“日用量”、“月用量”、“周用量”、“有效期内用量”是否需要清零，如果需要清零，则先清零后累计。
对于会话用量树，目前没有清零属性。
2、累计项不存在；
只对注册订阅过的用量进行累计。如果累计项节点不存在，不自动创建，不累计。
3、累计项无订阅
用量累计时遍历当前用量树下的每个累计项，若当前累计项没有人订阅，则认为此累计项失效，后续触发向SPR同步用量，通知SPR删除此用量，并且在本地删除此用量累计项节点。
4、用量如何累计
目前PCEF可以上报两种用量：业务用量、会话用量。RCP中有3种用量树：用户用量树、会话用量树、组用量树。
对PCEF上报的每个用量，FS调用UA的累计同步接口。UA据此可能会找到3棵用量树，对于每个用量树的处理如下：
遍历累计项，对每个累计项：逐个匹配各个属性字段，支持通配。若完全匹配，则说明此累计项可能需要累计。为什么说是“可能需要累计”，原因如下：
1）此过程中，需要对累计项进行有效性检查，若累计项失效，则不需累计。
2）若当前PCEF上报的是会话用量、或业务用量，当前匹配上的累计项是否累计，还有一套内部逻辑。
若RCP向PCEF同时下发了“会话级用量配额”和“业务级用量配额”，那么，用户用量、用户套餐用量、会话用量 只能来源于“PCEF上报的会话级用量”；业务套餐用量、SI用量、AppId用量 来源于“PCEF上报的业务级用量”。
若RCP向PCEF只发了“业务级用量配额”，那么，用户用量、用户套餐用量、业务套餐用量、SI用量、会话用量、AppId用量 都来源于“PCEF上报的业务级用量”。
若RCP向PCEF只下发了“会话级用量配额”，那么，用户用量、用户套餐用量、会话用量来源于“PCEF上报的会话级用量”；业务套餐用量、SI用量、AppId用量无法用量累计。
5、用量是否需要同步到SPR
目前只有用户用量、组需要同步到SPR。
对于用户用量，用量累计时，当用量累计当前值与上次同步给SPR的值相差超过阈值，或者 当前时间与上次同步时间超过一定的时间间隔并且用量值发生了变化，那么，需要将这些用量同步给SPR。
对于组用量，用量累计时，若当用量累计当前值与上次同步给SPR的值相差超过阈值，或者 当前时间与上次同步时间超过一定的时间间隔并且用量值发生了变化，那么，需要将这些用量增量上报给SPR。
6、是否有用量阈值事件发生
对某一个用量进行累计时，需要判断当前用量是否有阈值事件发生。目前，用户的阈值事件、组用量阈值事件需要异步通知FM。此外，在累计接口同步返回时，用户用量阈值事件和会话类用量阈值事件是否发生标志 都需要同步输出到输出参数。

实时用量的查询是：当用户在线的时候，SPR会触发PNR请求到PCRF上获取实时用量(flag第二位表示)；PCRF再触发RAR到PCEF上获取未上报的用量，然后把用量信息打包返回给SPR。
实时用量的查询，仅仅是针对用户用量。组用量SPR会直接返回SPR中存储的用量，不会到RCP中获取用量。


2.1.2.9SPR中无效记录的删除
当用户的某个套餐无效、用户某个SI无效、用户的某个累计项无人订阅，则从SPR中删除相应用量记录。
以下几种情况会检查是否需要删除SPR中的无效用量记录：
第一种情况，用户上线时，从SPR获取用量，此时会检查SPR用量记录中的用户、套餐、SI是否有效，若无效，则通知SPR删除该记录；
第二种情况， 用量累计或用户下线触发的用量同步，会检查套餐、SI是否有效，若无效，则从SPR中删除相应用量记录；
第三种情况，用量累计时，检查累计项是否有人订阅，若无订阅，删除SPR中该用户的所有用量记录。
补充说明：PNR更新用户签约数据时，如果


用量累计模块基本功能
用量订阅
用户（业务模块或其他系统）调用UA的订阅接口，通知UA需要累计哪些数据，以及数据达到特定阈值时要事件通知订阅者；
当前只提供同步订阅接口。接口定义见第10章节函数uaRegister的设计。

用量注销
用户（业务模块或其他系统）调用UA的注销接口，通知UA删除"阈值事件"或"累计数据"。
当前只提供同步注销接口。并且，只支持注销"阈值事件"。接口定义见第10章节函数uaDeRegister的设计。

用量阈值事件通知
用户向UA订阅了用量阈值事件后，在GGSN上报用量，UA进行用量累计的过程中，会检查用量是否达到阈值，如果达到阈值，则发送消息通知事件订阅者。

用量获取
用量获取，即通过Sp接口发送UDR消息向SPR获取用户的用量数据。目前，只有"用户用量"、"组用量"和 短信记录 需要远程存储到SPR。
用量获取包含异步过程，对于这个过程的处理，我们通过"事务"来实现。
FM提供"用量获取"事务。UA提供"用量获取"事务处理的一些同步/异步接口。

"用量获取"触发条件
用户上线时，FS发起用户的"用量获取"。
用户组内第一个组用户上线时，FS触发组的"用量获取"。

"用量获取"实现原理：
由FS "用量获取"事务，UA提供"用量获取"事务处理的一些同步/异步接口。
下图描述了"用量获取"模块间的协作，以及UA中的处理流程。

图5-2"用量获取"流程协作

"用量获取失败"的考虑
如果获取响应消息UDA中的响应码失败，则用量获取失败。某用户的用量获取失败时，不会触发再次获取；那么，此后，即便有业务模块注册阈值事件、或者要求累计用量，UA都会返回失败。对于组用量，也是如此。
如果用量获取超时：对于普通用户，后续业务模块注册阈值事件、或者要求累计用量，UA都会返回成功，但是不创建累计项不进行用量累计。对于组用量，后续组用户进行注册阈值事件、或者要求累计用量，都会触发再次向SPR获取组用量。

用量获取后的存储
从SPR获取到用量记录后，UA解析每一条用量记录。
首先，分解出关键字，获得用量属性；如果关键字非法，则记录下该用量记录，等解析完所有用量记录后，再触发用量同步，将无效的用量记录从SPR中删除；
然后，判断该用量是否过期或日期非法，如果过期或日期非法，则将该记录清零；在用量树中创建累计项节点，并将记录值填充到指定的用量累计项节点中。

用量上报
用量上报包含异步过程，对于这个过程的处理，我们通过"事务"来实现。
FM提供"用量同步"事务。UA提供"用量同步"事务处理的一些同步/异步接口。
用量同步，即通过Sp'接口发送UDR消息至SPR，向其同步当前用户的用量累计数据。对于用户用量，目前考虑"大增量上报"（所谓大增量上报，是指向SPR同步用量时，只同步用量累计值发生变化了的用量记录）。对于组用量，采用增量同步方式（即，每条用量记录，只上报用量增量值）。
目前，只有"用户用量"、"组用量"和 短信记录 需要远程存储到SPR。

"用量上报"触发条件
以下情况会触发用量上报：
第一种情况：用量获取时，在解析获取到用量时，发现该用量无效（解析错误、套餐或SI非法等等），则会触发用量同步，将这些无效的用量从SPR中删除。
第二种情况：用量累计过程中，如果当前累计总值与上次同步的值之差超过一定的阈值（网管配置）；或者上次同步的时间距离现在超过一定的时间间隔（网管配置），并且这期间用量发生了变化，则UA发送事件EV_UA_REPORT_USAGE给FS，通知同步用量。
第三种情况：用户下线时，会触发用量同步。用户下线触发的同步，此时UA会遍历该用户的所有用量记录：如果套餐或SI无效，则删除SPR中的相应用量记录；如果上次上报和当前累计值不同，则将该用量更新到SPR。

"用量上报"实现原理
由FM触发"用量上报"事务，UA提供"用量上报"事务处理的一些同步/异步接口。
下图描述了"用量上报"模块间的协作，以及UA中的处理流程。

图5-3 "用量上报"流程协作

对"用量上报"成功与否的考虑
正常情况下，如果向SPR用量同步失败收到UDA有错误码时，不会因此立即触发用量的再次同步。下次用量累积导致用量同步时会将之前同步失败的用量一起同步给SPR；如果向SPR同步用量超时（等待UDA超时），则FS会再次触发同步（目前最多总共3次）。
用户离线或用户注销时，触发用量同步，如果等待同步响应超时，则FS会再次触发同步（目前最多总共3次）。
如果收到的用量同步响应码失败，则也认为本次同步成功。

用量累计
当GGSN向RCP上报用量时，RCP的FS调用UA的同步接口进行用量累计。
UA根据输入信息，找到各个需要累计的用量树。
用量累计时，调用者需要提供以下信息：

业务路径长度；
签约类业务路径：IMSI，套餐ID，SI；
会话类业务路径：IPCAN会话数据区索引 和Session-Id，业务标识；
用量类型；
用量值；
漫游类型：bLocationScale（本地或漫游）。作为用量累计接口参数时，建议以下取值：
本地：bLocationScale=2
漫游：bLocationScale=3
流方向：1，上下行总；2，上行；3，下行。
NAI ID：NAI ID；若不区分NAI，则为0XFFFFFFFF。
如果知道NAI，那么需携带NAI ID。

SGSN ID：SGSN ID；若不区分SGSN，则为0XFFFFFFFF。
RAT：RAT; 若不区分RAT，则为0XFFFFFFFF。

用量累计过程中，需要考虑以下问题：

用量是否需要清零；
根据累计类型，调用清零判断处理回调函数。
对于用户用量树、组用量树，检查"日用量"、"月用量"、"周用量"、"有效期内用量"是否需要清零，如果需要清零，则先清零后累计。
对于会话用量树，目前没有清零属性。

累计项不存在；
只对注册订阅过的用量进行累计。如果累计项节点不存在，不自动创建，不累计。

累计项无订阅
用量累计时遍历当前用量树下的每个累计项，若当前累计项没有人订阅，即其下没有阈值事件节点，则认为此累计项失效，后续触发向SPR同步用量，通知SPR删除此用量，并且在本地删除此用量累计项节点。

用量如何累计
目前PCEF可以上报两种用量：业务用量、会话用量。RCP中有3种用量树：用户用量树、会话用量树、组用量树。
对PCEF上报的每个用量，FS调用UA的累计同步接口。UA据此可能会找到3棵用量树，对于每个用量树的处理如下：
遍历累计项，对每个累计项：逐个匹配各个属性字段，支持通配。若完全匹配，则说明此累计项可能需要累计。为什么说是"可能需要累计"，原因如下：
1）此过程中，需要对累计项进行有效性检查，若累计项失效，则不需累计。
2）若当前PCEF上报的是会话用量、或业务用量，当前匹配上的累计项是否累计，还有一套内部逻辑。
若RCP向PCEF同时下发了"会话级用量配额"和"业务级用量配额"，那么，用户用量、用户套餐用量、会话用量 只能来源于"PCEF上报的会话级用量"；业务套餐用量、SI用量、AppId用量 来源于"PCEF上报的业务级用量"。
若RCP向PCEF只发了"业务级用量配额"，那么，用户用量、用户套餐用量、业务套餐用量、SI用量、会话用量、AppId用量 都来源于"PCEF上报的业务级用量"。
若RCP向PCEF只下发了"会话级用量配额"，那么，用户用量、用户套餐用量、会话用量来源于"PCEF上报的会话级用量"；业务套餐用量、SI用量、AppId用量无法用量累计。

用量是否需要同步到SPR
目前只有用户用量、组需要同步到SPR。
对于用户用量，用量累计时，当用量累计当前值与上次同步给SPR的值相差超过阈值，或者 当前时间与上次同步时间超过一定的时间间隔并且用量值发生了变化，那么，需要将这些用量同步给SPR。
对于组用量，用量累计时，若当用量累计当前值与上次同步给SPR的值相差超过阈值，或者 当前时间与上次同步时间超过一定的时间间隔并且用量值发生了变化，那么，需要将这些用量增量上报给SPR。

是否有用量阈值事件发生
对某一个用量进行累计时，需要判断当前用量是否有阈值事件发生。目前，用户的阈值事件、组用量阈值事件需要异步通知FM。此外，在累计接口同步返回时，用户用量阈值事件和会话类用量阈值事件是否发生标志 都需要同步输出到输出参数。

用量清零
目前，只有"用户类用量"、"组用量"有清零属性。以下两种情况会判断是否需要用量清零：

在用量累计前，需要判断，对当前用户的月用量、日用量、有效期内用量、周用量是否需要清零
在其他业务模块调用UA接口查询用户当前某个用量值时，UA模块需要先检查用量是否需要清零，若需要清零，则反馈0值（实际此时并不进行清零）。
PNR更新用量签约数据时，例如：
用量累计方式 或 用户启帐日发生变化，则将该用户下的所有月用量清零；
套餐有效期发生变化并需要清零，则将该套餐的所有用量清零及相关的SI用量清零；
套餐/SI有效期发生变化导致用量值过期，则将过期的用量清零。

SPR中无效记录的删除
当用户的某个套餐无效、用户某个SI无效、用户的某个累计项无人订阅，则从SPR中删除相应用量记录。
以下几种情况会检查是否需要删除SPR中的无效用量记录：
第一种情况，用户上线时，从SPR获取用量，此时会检查SPR用量记录中的用户、套餐、SI是否有效，若无效，则通知SPR删除该记录；
第二种情况， 用量累计或用户下线触发的用量同步，会检查套餐、SI是否有效，若无效，则从SPR中删除相应用量记录；
第三种情况，用量累计时，检查累计项是否有人订阅，若无订阅，删除SPR中该用户的所有用量记录。
补充说明：PNR更新用户签约数据时，如果套餐、SI有效，不立即触发用量同步流程，因为上述几种情况已经能够清理SPR中无效记录。

用量触发的重决策点
一、非组用量
（1）用量累积流程：

阈值穿越或对应用量需清零：触发 此阈值相关的 会话重决策 和 短信决策。
规则版本号发生改变(GUI 在累计前后有变更提交)：触发用户级重决策。
当前用户下会话存在前一次决策失败场景(会话自累积流程 不考虑此触发点): 触发用户级重决策。

（2）受理触发PNR修改用量：

触发用户级重决策。

（3）ATM主动清零通知：

触发清零对象下阈值相关的会话重决策 和 短信决策。

二、组用量
（1）用量累积流程：

阈值穿越或对应用量需清零：组级重决策
规则版本号发生改变(GUI 在累计前后有变更提交)：组级重决策。

（2）PNR更新组用量：

前一次组下有成员的会话决策失败场景：触发该成员的用户级重决策
阈值穿越或规则版本号发生改变：组级重决策。

（3）ATM主动清零通知：

存在组用量清零：触发组级重决策。
用量的实时查询
之前，SPR查询的用量都是SPR数据库中存储的用量。当用户离线的时候，SPR查询到的用量就是用户当前的用量。但是当用户在线的时候，以前SPR查询到的用量就不准确了。 
实时用量的查询是：当用户在线的时候，SPR会触发PNR请求到PCRF上获取实时用量(flag第二位表示)；PCRF再触发RAR到PCEF上获取未上报的用量，然后把用量信息打包返回给SPR。
实时用量的查询，仅仅是针对用户用量。组用量SPR会直接返回SPR中存储的用量，不会到RCP中获取用量。

用量累计数据管理
"用量树"与"累计对象"的关系
一棵用量树由一个或多个累计对象、阈值、历史用量、订阅信息构成。
如何构造用量树？订阅者在订阅参数中，提供累计对象信息、及需要订阅的阈值和订阅者信息。
用量树的组成示意图如下：

图5-4 用量树

用量树的构造与销毁
1、用量树的构造
用户（其他JOB）订阅用量的过程，就是构造用量树的过程。此外，对于需要远程存储的用量（目前只有用户类用量、组用量），在远程用量获取时，就开始构造用量树。
2、用量树的销毁
对于用户类用量树，只有用户离线或用户注销时，才删除用量树。
对于会话类用量树，只有会话释放时，才删除用量树。
对于组用量树，只有组删除或组内最后一个用户离线，才删除用量树。

本函数的处理逻辑如下：
1）获取当前累计项的数据区内容；
2）当前累计对象有效性检查：
若套餐失效、SI失效等等，则不累计，将其用量值清零，并在本次累计全部完成后触发向SPR同步用量，通知SPR删除失效的累计对象，然后在RCP中删除此累计项。
若承载被删除、AfAppId不存在，则删除当前失效的累计项。
3）当前累计对象是否有人订阅
若当前累计对象无人订阅，则将其用量值清零，待本次累计全部完成后触发向SPR同步用量，通知SPR删除此累计对象，然后在RCP中删除此累计项。
4）检查累计对象是否需要清零
根据当前累计对象的周期属性，判断是否需要清零，若需要清零，则先清零，并通知订阅此用量的订阅者，该用量被清零。
清零判断，包含以下几个方面：
月用量是否跨月、日用量是否跨日、周用量是否跨周、N天周期性有效期内用量 是否跨N天周期；所有用量上次更新时间 是否 在有效期范围内。 以上任何一种满足，则需要清零。
5）进行关键字匹配，匹配过程如下：
if (1 == UA_KEYINFO_FLG_6_LAYER)
{
If (当前累计层次 > 上报的累计层次)
{
Return; 
}
比较 atSvcKey：若 不匹配，则Return;
}
If (1 == UA_KEYINFO_FLG_1_USGTYPE)
{
比较bUsgType：若 不匹配，则Return;
}
If (1 == UA_KEYINFO_FLG_2_AREATYPE)
{
比较bAreaType：若 不匹配，则Return;
}
If (1 == UA_KEYINFO_FLG_3_NAI)
{
比较dwNAI：若 不匹配，则Return;
}
If (1 == UA_KEYINFO_FLG_5_FLOWDIR)
{
比较bFlowDir：若 不匹配，则Return;
}
If (1 == UA_KEYINFO_FLG_8_SGSNID)
{
比较dwSGSNId：若 不匹配，则Return;
}
If (1 == UA_KEYINFO_FLG_9_RAT)
{
比较dwRAT：若 不匹配，则Return;
}
If (1 == UA_KEYINFO_FLG_10_TIMETYPE)
{
获取当前忙闲时类型；
比较bTimeType：若 不匹配，则Return;
} 
6）根据当前PCEF上报的级别，及当前累计项类型，判断是否需要累计。
若RCP向PCEF同时下发了"会话级用量配额"和"业务级用量配额"，那么，用户用量、用户套餐用量、会话用量 只能来源于"PCEF上报的会话级用量"；业务套餐用量、SI用量、AFAppId用量 来源于"PCEF上报的业务级用量"。
若RCP向PCEF只发了"业务级用量配额"，那么，用户用量、用户套餐用量、业务套餐用量、SI用量、会话用量、AFAppId用量 都来源于"PCEF上报的业务级用量"。
若RCP向PCEF只下发了"会话级用量配额"，那么，用户用量、用户套餐用量、会话用量来源于"PCEF上报的会话级用量"；业务套餐用量、SI用量、AFAppId用量无法用量累计。
7）对当前累计对象进行用量累计，并记录下本次更新时间。
8）判断是否需要向SPR同步用量：
若需要向SPR同步用量，则设置出参pbIsNeedRptUsg，标识需要同步用量。
9）检查是否有用量阈值事件发生：
若有用量阈值事件发生，则设置出参pbIsNeedNtfEvt，标识有阈值事件发生，并将事件内容打包在出参ptNtfToFm中。


处理逻辑
本函数的处理逻辑如下。
1）获取待同步的用量树的用量根节点；如果不是用户用量树或组用量树，则不需要向SPR同步，函数返回。
2）if当前用户是组成员：
则判断他的Group所在的模块号实例号是否发生变化,发生变化则通知原来模块 删除组数据。
3）调用分发函数，获取当前应该所在的模块号实例号，若不是本模块本实例，则不需要向SPR同步。(解决扩容缩容影响)
4）判断用户或 组 是否从SPR中成功获取过用量记录，若没有，则不需要用量同步。
5）根据"触发同步的原因码"：
5-1）case: UA_USG_RPT_RSN_INIT // 初始用量获取用量无效触发的上报
将全局缓冲区中记录的需要删除的用量记录填充到UDR中；
break;
5-2）case: UA_USG_RPT_RSN_NOMAL // 用户在线期间正常触发
Case: UA_USG_RPT_RSN_USEROFFLINE //用户离线触发
遍历 用量树中的每个用量对象节点，处理如下：
5-2-1）判断累计对象是否失效：
若失效，则将其放到 Info_Remove AVP中；并将该累计对象打上删除标记。
5-2-2）原因码为UA_USG_RPT_RSN_NOMAL时，检查该累计对象是否无人订阅：
若无人订阅，则将其放到 Info_Remove AVP中；并将该累计对象用量值清零并打上删除标记。
5-2-3）其他情况，判断是否需要清零：若需要，则清零，并打包阈值事件。
然后将用量编码，放到Info_Install AVP中。
此时，对于普通用户，则全量上报；
对于组，则采用增量上报。
5-3）case: UA_USG_RPT_RSN_PNRDEREG //用户注销
在UDR中设置 Remove_All_Used_Service_Info AVP。
5-4）其他：原因码非法。返回失败。
6）以上检查若 没有待同步的用量，则函数返回：错误码为RCP_UA_ERROR_NO_INFO_RPT_TO_SPR。
7）设置UDR中其他AVP的内容。
8）发送UDR。
9）函数返回。


处理逻辑
本函数的处理逻辑如下。
1）参数有效性检查；
2）获取用量根节点：
用户用量根节点（或组用量根节点），会话用量根节点。
3）遍历PCEF上报的每个用量，对每个上报的用量处理如下：
对于 用户类或组类用量树，提取并构造 用户类或组类的 用量关键信息；对于 会话类用量树，提取并构造 会话类 用量关键信息。
依次处理 第2）步获取到的每个用量树，对每个用量树的处理如下：
3-1）遍历当前用量树的每一条用量累计对象：
调用内部函数uaAccuObj，进行用量累计处理。
3-2）继续处理下一个累计对象，直至遍历完成。
4）累计完成后，判断是否需要向SPR同步用量：
如需要，则发送事件通知FS，由FS触发向SPR同步用量。
5）判断 是否有用量阈值事件发生：
若有用量阈值事件发生，则将阈值事件打包发送给FS，由FS触发相关的重决策。
构造提取用户类或组类的 用量关键信息，处理 用户类用量树，
说明：会话类的用量阈值事件不需要异步通知，直接由本次同步接口调用返回。
6）如果当前 是组用户：
6-1）获取组用户所属的组；构造 组用量累计参数；调用分发，获得主帐户所在的模块号实例号；
6-2）判断组的模块号实例号是否发生变化(扩容缩容)，若发生变化，则通知删除原来的Group用量,并记录下最新的组的模块号实例号；


处理逻辑
本函数的处理逻辑如下。
1）获取用量根节点；
2）如果用户上线时没有成功获取过用量，则不处理，直接返回成功。
3）获取当前用户最新的用量累计方式和启帐日，并与之前的比较：
3-1）若累计方式或启帐日发生变化： 则将该用户下所有 月用量清零。
4）遍历累计对象：
4-1）若累计对象失效，则 用量清零，并且删除事件节点。
4-2）若累计对象有效：
4-2-1）如果为套餐用量
则判断PAK的有效期是否发生变化：若变化且需清零，则将PAK用量清零,不删除阈值事件；并且，判断当前套餐用量 最后一次更新时间是否在有效期范围，若不在有效期范围内，则清零。
4-2-2）如果为SI用量
则判断所属的PAK的有效期是否发生变化：若变化并且需清零，则将SI用量清零,不删除阈值事件；并且，判断当前用量 最后一次更新时间是否在PAK有效期范围和SI有效期范围内，若不在有效期范围内，则清零。
5）函数返回。
备注：以上清零处理后，不需要发送阈值事件，因为当前流程是签约检查 FS会触发重决策。
